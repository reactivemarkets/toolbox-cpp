<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Toolbox: Messaging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Toolbox
   &#160;<span id="projectnumber">snapshot</span>
   </div>
   <div id="projectbrief">The Reactive C++ Toolbox</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Messaging </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Max Size</h1>
<p>A sensible upper-bound for message payloads is 1400 bytes:</p>
<ol type="1">
<li>Max Datagram (1472) - Aeron header (32) = 1440</li>
<li>Round-down to cache-line boundary: (1440 &amp; ~63) = 1408</li>
<li>Subtract MPMC queue header (8): 1408 - 8 = 1400</li>
</ol>
<h1>UDP</h1>
<p>The User Datagram Protocol (UDP) is a message-oriented transport layer protocol. UDP is the most common transport layer protocol used with multicast addressing.</p>
<p>UDP is a simple, stateless protocol that is best suited to applications that can tolerate:</p>
<ul>
<li>congested buffers and networks;</li>
<li>duplicate messages;</li>
<li>lost messages;</li>
<li>messages received out-of-order.</li>
</ul>
<p>For these reasons, UDP is often referred to as an unreliable protocol.</p>
<h2>MTU</h2>
<p>Although UDP supports datagrams of up to 64K in length, packing them into a single Maximum Transmission Unit (MTU) is highly desirable to avoid fragmentation and subsequent reassembly. By default, Linux will return <code>EMSGSIZE</code> if a user attempts to send a datagram that exceeds the target link's MTU.</p>
<p>UDP adds 8 bytes to the 20 byte header used by the IP protocol:</p>
<div class="fragment"><div class="line"> 0      7 8     15 16    23 24    31</div>
<div class="line">+--------+--------+--------+--------+</div>
<div class="line">|     Source      |   Destination   |</div>
<div class="line">|      Port       |      Port       |</div>
<div class="line">+--------+--------+--------+--------+</div>
<div class="line">|                 |                 |</div>
<div class="line">|     Length      |    Checksum     |</div>
<div class="line">+--------+--------+--------+--------+</div>
<div class="line">|</div>
<div class="line">|          Data Octets ...</div>
<div class="line">+---------------- ...</div>
</div><!-- fragment --><p>The maximum size of a datagram that avoids fragmentation is, therefore, the MTU size minus 28 bytes. This can be verified on a link with an MTU of 1500 bytes as follows: </p><pre class="fragment">$ ping -M do -c 1 -s 1472 www.reactivemarkets.com
</pre><h1>Reliable UDP</h1>
<p>UDP can be made more reliable by adding sequence numbers to the application protocol; receivers can implement a receive window to detect duplicates and restore datagram order.</p>
<p>Re-sending the last datagram at regular intervals may be used as a form of keep-alive and for detecting tail-loss on low volume channels.</p>
<p>When a sequence gap is detected, the receiver must use a suitable method for recovering lost transmissions. Recovery can be achieved by sending a Negative Acknowledgements (NAKs) back upstream to the sender. Care must be taken, however, to avoid re-request storms that further burden the network and risk compounding any capacity-related issues.</p>
<p>A solution often deployed by market-data feeds is to provide a separate recovery channel that periodically broadcasts snapshots for late-join or recovery purposes. Snapshot and delta channels use the same sequence numbers, so that they can be synchronised by downstream consumers. The main advantage of this approach is that events continue to flow in a single direction at a predictable rate.</p>
<h1>TCP</h1>
<p>Several characteristics of the Transmission Control Protocol (TCP) make it a more suitable for reliable messaging than UDP:</p>
<ul>
<li>Ordering TCP uses sequence numbers to ensure that data is received by the consuming application in the same order that it was sent. Receive windows are maintained by receivers for reassembling data in the correct order.</li>
<li>Flow-control the receiver's remaining window-size is communicated back to the sender, so that the sender can limit the transmission rate to avoid overwhelming the consumer.</li>
<li>Recovery sending applications will automatically retransmit data that has not been acknowledged by the consumer within a certain time period.</li>
</ul>
<p>In addition, the connected nature of TCP streams and their APIs allow applications to perform specific actions when streams are connected and disconnected.</p>
<p>Disclaimer: these points are intended to highlight key reliability features only. (Consult your favourite TCP reference for more advanced features, including TCP's network congestion avoidance algorithms.)</p>
<p>In summary, UDP is ideal for messages that:</p>
<ul>
<li>fit within a single MTU;</li>
<li>do not depend on their predecessors;</li>
<li>may be received out-of-order;</li>
<li>may occasionally be lost;</li>
<li>use multicast addressing.</li>
</ul>
<p>Good candidates for UDP are application heartbeats and snapshot-based market-data feeds.</p>
<p>TCP should generally be preferred otherwise.</p>
<h1>Late-join</h1>
<p>When a client subscribes to a stream, depending on the type of data, it may need to synchronise with the current "state of the world". This is normally achieved by replaying historical messages or by sending a snapshot.</p>
<p>A typical example would be a delta-based market-data feed, where clients must acquire the current state of the order-book, on which subsequent deltas can be applied.</p>
<p>Such problems are easily solved using a reliable, connection-oriented protocol like TCP:</p>
<ul>
<li>the client establishes a connection;</li>
<li>the server sends an initial snapshot of the order-book;</li>
<li>the server sends a sequence of deltas to apply.</li>
</ul>
<h1>Packing</h1>
<p>Packed data-structures are important for message encodings where smaller sizes require less bandwidth, decrease transmit times, and help to avoid fragmentation when message-oriented protocols such as UDP are used.</p>
<p>This is often in contrast with design considerations for internal data-structures. Concurrent data-structures such as Events in the Disruptor pattern, for example, are often padded to avoid false sharing and to adhere with the single-writer principle. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
